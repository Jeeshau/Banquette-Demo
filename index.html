<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>Banquette Demo + Modes + Ground Shadow</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- model-viewer -->
  <script type="module" src="https://unpkg.com/@google/model-viewer@^4/dist/model-viewer.min.js"></script>
  <style>
    :root{
      --bg:#0f1115; --fg:#f5f7fb; --muted:#aab2c0; --brand:#7aa2ff;
    }
    html,body{height:100%;margin:0;font:14px/1.45 system-ui,sans-serif;color:var(--fg);background:var(--bg)}
    .wrap{max-width:1100px;margin:0 auto;padding:20px}

    /* 控件样式 */
    .bar{margin-top:14px;background:#121722;border:1px solid #202634;border-radius:14px;padding:12px}
    .row{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .row-left{display:flex;gap:10px;align-items:center}
    .pill{font-size:12px;padding:4px 8px;border:1px solid #263043;border-radius:999px;color:#9fb4d6;background:transparent}
    progress{width:180px;height:10px}

    /* Viewer 容器 + 接地圆 */
    .viewer-wrap { position: relative; }
    model-viewer{width:100%;height:68vh;background:#0e131a;border:1px solid #202634;border-radius:18px}
    .ground {
      position:absolute;
      left:50%; bottom:18px;
      transform:translateX(-50%);
      width:42%; height:10%;
      background: radial-gradient(ellipse at center,
                  rgba(0,0,0,0.35), rgba(0,0,0,0) 70%);
      filter: blur(2px);
      pointer-events: none;
    }
  </style>
</head>
<body>

<div class="wrap">
  <section id="stepViewer">
    <div class="viewer-wrap">
      <model-viewer id="viewer"
        src="./model001.glb"
        camera-controls
        auto-rotate
        shadow-intensity="1"
        shadow-softness="0.9"
        exposure="1.2"
        environment-image="neutral"
        autoplay>
      </model-viewer>
      <!-- 接地圆 -->
      <div class="ground"></div>
    </div>

    <div class="bar">
      <div class="row">
        <div class="row-left">
          <span class="pill">形态阶段</span>
          <span id="curLabel">model001</span>
        </div>
        <div class="row-left">
          <span>加载进度</span>
          <progress id="prog" max="1" value="0"></progress>
          <span id="pct">0%</span>
        </div>
        <!-- 渲染模式切换器 -->
        <div class="row-left">
          <span>显示模式</span>
          <select id="modeSelect" class="pill">
            <option value="arctic">Arctic</option>
            <option value="shaded" selected>Shaded</option>
            <option value="studio">Studio</option>
            <option value="art">This is an art</option>
          </select>
        </div>
      </div>
      <input id="slider" type="range" min="1" max="3" step="1" value="1">
      <div class="row" style="margin-top:6px">
        <small>提示：拖动滑条切换阶段，拖拽模型可旋转/缩放</small>
        <a id="open" href="./model001.glb" target="_blank">直接打开当前模型</a>
      </div>
    </div>
  </section>
</div>

<script>
  const MODELS = ["model001.glb","model002.glb","model003.glb"];
  const viewer = document.getElementById('viewer');
  const slider = document.getElementById('slider');
  const curLabel = document.getElementById('curLabel');
  const prog = document.getElementById('prog');
  const pct = document.getElementById('pct');
  const openA = document.getElementById('open');
  const modeSelect = document.getElementById('modeSelect');

  // HDRI 路径
  const HDR_SHADED = "https://modelviewer.dev/shared-assets/environments/spruit_sunrise_1k.hdr";
  const HDR_STUDIO = "https://modelviewer.dev/shared-assets/environments/studio_small_09_1k.hdr";
  const HDR_ART = "./Background_sculpture_exhibition_4k.hdr"; // 你的 HDRI

  // 模型切换
  function setModelByIndex(idx){
    const name = MODELS[idx];
    curLabel.textContent = name.replace('.glb','');
    openA.href = './' + name;
    viewer.src = name + '?v=' + Date.now();
  }

  slider.addEventListener('input', () => {
    const idx = Math.max(0, Math.min(MODELS.length-1, Number(slider.value)-1));
    setModelByIndex(idx);
  });

  // 进度监听
  viewer.addEventListener('progress', (e) => {
    const p = e.detail?.totalProgress ?? 0;
    prog.value = p;
    pct.textContent = Math.round(p * 100) + '%';
  });
  viewer.addEventListener('load', () => { prog.value = 1; pct.textContent = '100%'; });

  // 模式切换
  async function setHDRSafe(hdrUrl, {bg="#ddd", exposure=1.25, shadow=1} = {}) {
    try {
      const res = await fetch(hdrUrl, {cache:"no-store"});
      if (!res.ok) throw new Error("HDRI not found");
      viewer.style.background = bg;
      viewer.setAttribute('environment-image', hdrUrl);
      viewer.setAttribute('skybox-image', hdrUrl);
      viewer.setAttribute('exposure', String(exposure));
      viewer.setAttribute('shadow-intensity', String(shadow));
      viewer.setAttribute('shadow-softness','0.9');
    } catch(e) {
      console.warn("[HDRI] load failed, fallback to neutral:", e.message);
      viewer.removeAttribute('skybox-image');
      viewer.setAttribute('environment-image','neutral');
      viewer.style.background = '#ededed';
      viewer.setAttribute('exposure','1.3');
      viewer.setAttribute('shadow-intensity','0.8');
      viewer.setAttribute('shadow-softness','0.9');
    }
  }

  async function applyMode(mode){
    if (mode === 'arctic') {
      viewer.removeAttribute('skybox-image');
      viewer.setAttribute('environment-image','neutral');
      viewer.style.background = '#f0f0f0';
      viewer.setAttribute('exposure','1.25');
      viewer.setAttribute('shadow-intensity','0.5');
      viewer.setAttribute('shadow-softness','0.9');
      return;
    }
    if (mode === 'shaded') {
      await setHDRSafe(HDR_SHADED, {bg:"#000", exposure:1.2, shadow:1});
      return;
    }
    if (mode === 'studio') {
      await setHDRSafe(HDR_STUDIO, {bg:"#0e131a", exposure:1.05, shadow:0.9});
      return;
    }
    if (mode === 'art') {
      await setHDRSafe(HDR_ART, {bg:"#111", exposure:1.1, shadow:0.9});
      return;
    }
  }

  modeSelect?.addEventListener('change', e => applyMode(e.target.value));
  applyMode(modeSelect?.value || 'shaded'); // 初始模式
</script>
</body>
</html>
