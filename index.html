<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Interactive Viewer — Angle / Distance / Target</title>
  <style>
    html, body { height: 100%; margin: 0; background: #000; overflow: hidden; }
    model-viewer { width: 100%; height: 100%; background: transparent; --poster-color: transparent; }
    .panel {
      position: absolute; left: 12px; top: 12px; display: grid; gap: 8px;
      grid-template-columns: auto auto; align-items: center;
      padding: 10px 12px; border-radius: 12px;
      background: rgba(0,0,0,.4); backdrop-filter: blur(6px);
      color:#fff; font: 13px/1.2 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial;
    }
    .panel label { opacity:.9 }
    .panel input[type="range"] { width: 220px; }
    .row { grid-column: 1 / -1; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .row > * { margin: 0 }
    .num { width: 64px; padding: 4px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.1); color:#fff }
    .sel { padding: 4px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.1); color:#fff }
    .btn {
      border: 0; border-radius: 8px; padding: 6px 10px; cursor: pointer;
      background: rgba(255,255,255,.15); color:#fff;
    }
    .btn.primary { background:#fff; color:#111 }
    .note {
      position:absolute; right:12px; bottom:12px; max-width: 48ch;
      background: rgba(0,0,0,.55); color:#fff; padding:10px 12px; border-radius:10px;
      font: 12px/1.4 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; white-space: pre-wrap;
    }
  </style>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
</head>
<body>
  <model-viewer id="mv"
    src="./model003.glb"             <!-- 预设查看 model003 -->
    camera-controls
    interaction-prompt="none"
    field-of-view="20deg"
    style="background: transparent;"
    camera-orbit="0deg 90deg 150in"  <!-- 初始：水平视角 + 150" 距离 -->
    camera-target="0m 0.889m 0m"     <!-- 35" ≈ 0.889m，作为目标高度 -->
    reveal-when-loaded
  ></model-viewer>

  <div class="panel" id="ui">
    <div class="row">
      <label>Model</label>
      <select id="modelSel" class="sel">
        <option value="./model001.glb">model001.glb</option>
        <option value="./model002.glb">model002.glb</option>
        <option value="./model003.glb" selected>model003.glb</option>
      </select>
      <label title="勾选后加载 ./Background_sculpture_exhibition_4k.hdr">
        <input type="checkbox" id="hdr"> HDRI
      </label>
      <label title="锁定当前 r（min/max 同步为 r）">
        <input type="checkbox" id="lockR"> Lock Distance
      </label>
    </div>

    <label>θ 水平角 (deg)</label>
    <div class="row">
      <input type="range" id="theta" min="-180" max="180" step="0.1" value="0">
      <input type="number" id="thetaNum" class="num" step="0.1" value="0">
    </div>

    <label>φ 俯仰角 (deg)</label>
    <div class="row">
      <input type="range" id="phi" min="0" max="180" step="0.1" value="90">
      <input type="number" id="phiNum" class="num" step="0.1" value="90">
    </div>

    <label>r 距离 (in)</label>
    <div class="row">
      <input type="range" id="radius" min="10" max="600" step="1" value="150">
      <input type="number" id="radiusNum" class="num" step="1" value="150">
      <button class="btn" id="r150">150"</button>
      <button class="btn" id="r200">200"</button>
      <button class="btn" id="r250">250"</button>
    </div>

    <label>Target Y 目标高度 (in)</label>
    <div class="row">
      <input type="range" id="targetY" min="-120" max="120" step="0.5" value="35">
      <input type="number" id="targetYNum" class="num" step="0.5" value="35">
      <button class="btn" id="y0">Y=0"</button>
      <button class="btn" id="y35" title="常用">Y=35"</button>
      <button class="btn" id="y60">Y=60"</button>
    </div>

    <div class="row" style="opacity:.85">
      <div id="readout">orbit: 0° 90° 150in • target: (0, 35", 0)</div>
    </div>
    <div class="row">
      <button class="btn" id="frame">Frame 找回画面</button>
      <button class="btn primary" id="reset">重置</button>
    </div>
  </div>

  <div class="note" id="note">Ready.</div>

  <script>
    const mv = document.getElementById('mv');
    const note = (t) => document.getElementById('note').textContent = t;

    // UI elements
    const modelSel   = document.getElementById('modelSel');
    const hdrToggle  = document.getElementById('hdr');
    const lockRChk   = document.getElementById('lockR');

    const theta     = document.getElementById('theta');
    const thetaNum  = document.getElementById('thetaNum');
    const phi       = document.getElementById('phi');
    const phiNum    = document.getElementById('phiNum');
    const radius    = document.getElementById('radius');
    const radiusNum = document.getElementById('radiusNum');

    const targetY      = document.getElementById('targetY');      // inches
    const targetYNum   = document.getElementById('targetYNum');   // inches

    const readout   = document.getElementById('readout');

    const r150 = document.getElementById('r150');
    const r200 = document.getElementById('r200');
    const r250 = document.getElementById('r250');

    const y0  = document.getElementById('y0');
    const y35 = document.getElementById('y35');
    const y60 = document.getElementById('y60');

    const frameBtn = document.getElementById('frame');
    const resetBtn = document.getElementById('reset');

    // helpers
    const inToM = (inch) => inch * 0.0254;
    const clamp = (v, a, b) => Math.min(Math.max(v, a), b);

    function syncOrbitAttrs() {
      const t = parseFloat(theta.value);
      const p = parseFloat(phi.value);
      const r = parseFloat(radius.value);
      mv.setAttribute('camera-orbit', `${t}deg ${p}deg ${r}in`);

      if (lockRChk.checked) {
        mv.setAttribute('min-camera-orbit', `auto ${p}deg ${r}in`);
        mv.setAttribute('max-camera-orbit', `auto ${p}deg ${r}in`);
      } else {
        mv.removeAttribute('min-camera-orbit');
        mv.removeAttribute('max-camera-orbit');
      }
      updateReadout();
    }

    function syncTarget() {
      const yIn = parseFloat(targetY.value);
      mv.setAttribute('camera-target', `0m ${inToM(yIn)}m 0m`);
      updateReadout();
    }

    function updateReadout() {
      const yIn = parseFloat(targetY.value).toFixed(1);
      readout.textContent = `orbit: ${theta.value}°  ${phi.value}°  ${radius.value}in  •  target: (0, ${yIn}", 0)`;
    }

    // tie range + number inputs
    function bindPair(rangeEl, numEl, onChange) {
      const sync = (src, dst) => () => { dst.value = src.value; onChange(); };
      rangeEl.addEventListener('input', sync(rangeEl, numEl));
      numEl.addEventListener('input', () => {
        rangeEl.value = clamp(parseFloat(numEl.value||0), parseFloat(rangeEl.min), parseFloat(rangeEl.max));
        onChange();
      });
    }
    bindPair(theta, thetaNum, syncOrbitAttrs);
    bindPair(phi,   phiNum,   syncOrbitAttrs);
    bindPair(radius, radiusNum, syncOrbitAttrs);
    bindPair(targetY, targetYNum, syncTarget);

    // quick buttons
    r150.addEventListener('click', () => { radius.value = radiusNum.value = 150; syncOrbitAttrs(); });
    r200.addEventListener('click', () => { radius.value = radiusNum.value = 200; syncOrbitAttrs(); });
    r250.addEventListener('click', () => { radius.value = radiusNum.value = 250; syncOrbitAttrs(); });

    y0.addEventListener('click',  () => { targetY.value = targetYNum.value = 0;  syncTarget(); });
    y35.addEventListener('click', () => { targetY.value = targetYNum.value = 35; syncTarget(); });
    y60.addEventListener('click', () => { targetY.value = targetYNum.value = 60; syncTarget(); });

    // model switch
    modelSel.addEventListener('change', () => {
      mv.setAttribute('src', modelSel.value); // 相对路径 ./model003.glb 等
      note(`Loading: ${modelSel.value}`);
    });

    // HDRI toggle — 勾选后再加载
    hdrToggle.addEventListener('change', () => {
      if (hdrToggle.checked) {
        mv.setAttribute('environment-image', './Background_sculpture_exhibition_4k.hdr');
        mv.setAttribute('skybox-image', './Background_sculpture_exhibition_4k.hdr');
        mv.setAttribute('exposure', '1.0');
        note('HDRI 已启用');
      } else {
        mv.removeAttribute('environment-image');
        mv.removeAttribute('skybox-image');
        note('HDRI 已关闭');
      }
    });

    // Frame：用包围盒估计一个可视距离（不改变 φ/θ，也不改变 Target Y）
    frameBtn.addEventListener('click', () => {
      try {
        const box = mv.getBoundingBox?.();
        if (!box) throw new Error('no bbox');
        const dx = box.maxX - box.minX, dy = box.maxY - box.minY, dz = box.maxZ - box.minZ;
        const diag = Math.sqrt(dx*dx + dy*dy + dz*dz);
        const rM = Math.max(0.01, diag * 1.2);
        const rIn = Math.round(rM / 0.0254); // m -> in
        radius.value = radiusNum.value = clamp(rIn, parseFloat(radius.min), parseFloat(radius.max));
        syncOrbitAttrs();
        note('已尝试找回画面');
      } catch { note('Frame 失败（模型未就绪或浏览器不支持 bbox API）'); }
    });

    // Reset
    resetBtn.addEventListener('click', () => {
      theta.value = thetaNum.value = 0;
      phi.value   = phiNum.value   = 90;
      radius.value = radiusNum.value = 150;
      targetY.value = targetYNum.value = 35;
      lockRChk.checked = false;
      hdrToggle.checked = false;
      mv.removeAttribute('environment-image');
      mv.removeAttribute('skybox-image');
      mv.setAttribute('src', './model003.glb'); // 回到你要看的 model003
      syncTarget();
      syncOrbitAttrs();
      note('已重置到默认（model003, r=150", φ=90°, Y=35"）');
    });

    // 初始同步
    mv.addEventListener('load', () => { syncTarget(); syncOrbitAttrs(); note('Loaded. 可开始调参数。'); });
    mv.addEventListener('error', () => { note('❌ 资源加载失败：请检查文件是否与 index.html 在同一目录、文件名大小写一致。'); });
  </script>
</body>
</html>
